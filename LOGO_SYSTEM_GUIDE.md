# دليل استخدام نظام الشعارات الديناميكي

## نظرة عامة

تم تطوير نظام متكامل لإدارة شعار المحل بشكل ديناميكي، مما يسمح بـ:
- رفع شعار مخصص لكل محل
- تحديث الشعار في أي وقت دون الحاجة لإعادة رفع التطبيق
- عرض الشعار تلقائياً في جميع الإيصالات
- العودة للشعار الافتراضي في أي وقت

---

## الملفات المضافة والمعدلة

### ملفات جديدة:
1. **services/logoService.ts** - خدمة إدارة الشعارات (رفع، حذف، تحديث)
2. **app/shop-settings.tsx** - صفحة إعدادات المحل الكاملة
3. **LOGO_SETUP.md** - تعليمات إعداد Storage Bucket
4. **supabase/migrations/[timestamp]_create_storage_bucket_for_logos.sql** - Migration لإنشاء Bucket

### ملفات معدلة:
1. **utils/logoHelper.ts** - تحديث لدعم الشعار من قاعدة البيانات
2. **contexts/AuthContext.tsx** - إضافة دالة updateSettings
3. **app/(tabs)/settings.tsx** - ربط زر إعدادات المحل

---

## كيفية الاستخدام

### 1. الدخول إلى إعدادات المحل

1. افتح التطبيق
2. اذهب إلى تبويب **الإعدادات** (Settings)
3. اضغط على **إعدادات المحل**

### 2. رفع شعار جديد

لديك خياران لرفع الشعار:

**الخيار الأول: من المعرض**
- اضغط على زر "اختر من المعرض"
- اختر صورة من معرض الصور
- سيتم عرض معاينة للصورة

**الخيار الثاني: التقاط صورة**
- اضغط على زر "التقاط صورة"
- استخدم الكاميرا لالتقاط صورة للشعار
- سيتم عرض معاينة للصورة

### 3. تعديل معلومات المحل

يمكنك تحديث:
- اسم المحل (إجباري)
- رقم الهاتف (اختياري)
- العنوان (اختياري)

### 4. حفظ التغييرات

- اضغط على زر "حفظ التغييرات" في الأسفل
- سيتم رفع الشعار وحفظ جميع المعلومات
- ستظهر رسالة تأكيد عند النجاح

### 5. حذف الشعار

- اضغط على زر "حذف" بجانب الشعار
- أكد الحذف
- سيعود التطبيق لاستخدام الشعار الافتراضي

---

## المميزات التقنية

### 1. الأولوية في عرض الشعار

يتبع النظام الترتيب التالي:
1. الشعار المخصص من قاعدة البيانات (إن وجد)
2. الشعار الافتراضي من assets/images/logo.jpg

### 2. دعم جميع المنصات

- **Web**: عرض مباشر من URL
- **Mobile (iOS/Android)**: تحويل تلقائي إلى Base64 للإيصالات

### 3. معالجة الأخطاء

- في حالة فشل تحميل الشعار من الإنترنت، يتم استخدام الشعار الافتراضي
- رسائل خطأ واضحة للمستخدم
- تسجيل تفصيلي للأخطاء في Console

### 4. الأمان

- رفع الصور محمي بـ RLS policies
- فقط المستخدمين المصادق عليهم يمكنهم رفع/حذف الشعارات
- الشعارات عامة (public) للعرض

### 5. الأداء

- حد أقصى لحجم الملف: 5 MB
- أنواع الملفات المدعومة: JPG, JPEG, PNG, WEBP
- ضغط تلقائي للصور عند الرفع (جودة 80%)

---

## استكشاف الأخطاء

### المشكلة: "Failed to upload logo"

**الأسباب المحتملة:**
- Bucket غير موجود في Supabase Storage
- Bucket غير عام (not public)
- سياسات الأمان غير مضبوطة

**الحل:**
- راجع ملف LOGO_SETUP.md
- تأكد من تطبيق Migration الخاص بالـ Storage

### المشكلة: "Permission denied"

**السبب:**
- سياسات RLS غير مضبوطة بشكل صحيح

**الحل:**
```sql
-- تأكد من وجود هذه السياسات
SELECT * FROM pg_policies
WHERE schemaname = 'storage'
AND tablename = 'objects';
```

### المشكلة: الشعار لا يظهر في الإيصالات

**الأسباب المحتملة:**
- رابط الشعار غير محفوظ في قاعدة البيانات
- مشكلة في الاتصال بالإنترنت

**الحل:**
- تحقق من جدول app_settings:
```sql
SELECT shop_logo FROM app_settings;
```
- تأكد من أن رابط الشعار يعمل في المتصفح

---

## الإعداد الأولي (للمطورين)

### الخطوة 1: إنشاء Storage Bucket

قم بتطبيق migration أو نفذ SQL التالي:

```sql
-- إنشاء bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('shop-logos', 'shop-logos', true);
```

### الخطوة 2: إضافة سياسات الأمان

راجع ملف LOGO_SETUP.md للتعليمات الكاملة.

### الخطوة 3: التحقق

```bash
# تشغيل التطبيق
npm run dev

# فحص الأنواع
npm run typecheck
```

---

## الأسئلة الشائعة

### س: هل يمكن استخدام نفس الشعار لعدة محلات؟
ج: نعم، الشعار مرتبط بإعدادات التطبيق (app_settings) وليس بمحل محدد.

### س: ما هي أفضل أبعاد للشعار؟
ج: يُنصح باستخدام صورة مربعة (1:1) بدقة 500x500 بكسل على الأقل.

### س: هل يمكن رفع شعار بصيغة SVG؟
ج: حالياً يدعم النظام JPG, PNG, WEBP فقط. SVG غير مدعوم.

### س: ماذا يحدث للشعار القديم عند رفع شعار جديد؟
ج: يتم حذفه تلقائياً من Supabase Storage لتوفير المساحة.

### س: هل الشعار يعمل بدون اتصال بالإنترنت؟
ج: الشعار الافتراضي (من assets) يعمل دائماً. الشعار المخصص يتطلب اتصال بالإنترنت للتحميل.

---

## الدعم الفني

إذا واجهت أي مشاكل:
1. تحقق من console logs في التطبيق
2. راجع ملف LOGO_SETUP.md
3. تأكد من تطبيق جميع migrations
4. تحقق من سياسات الأمان في Supabase Dashboard
