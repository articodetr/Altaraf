# ุฏููู ูุธุงู ุงูุนูููุฉ ุงูุชููุงุฆู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุงูุนูููุงุช ุจุดูู ุชููุงุฆูุ ุญูุซ ูุชู ุชุณุฌูู ุฌููุน ุงูุนูููุงุช ูู ุญุณุงุจ ุฎุงุต ููุณูู **"ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ"** (Profit & Loss Account).

---

## ุงูููุงููู ุงูุฃุณุงุณูุฉ

### 1. ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ

**ุงูุฎุตุงุฆุต:**
- โ ุญุณุงุจ ูุธุงู ุซุงุจุช ูุง ูููู ุญุฐูู ููุงุฆูุงู
- โ ูููู ุชุนุฏูู ุงุณู ุงูุญุณุงุจ ููุท (Rename)
- โ ูุธูุฑ ุจุดูู ูููุฒ ูู ูุงุฆูุฉ ุงูุนููุงุก (ุฎูููุฉ ุฐูุจูุฉ + ุฃููููุฉ TrendingUp ๐ฐ)
- โ ุฌููุน ุงูุนูููุงุช ุชูุณุฌู ููู ุชููุงุฆูุงู
- โ ูุง ูููู ุชุตููุฑ ุงูุญุณุงุจ ุฃู ุญุฐูู ูู ุงููุงุฌูุฉ

**ููููุฉ ุงูุชุนุฑู ุนููู:**
- ุงูุญูู `is_profit_loss_account = true` ูู ุฌุฏูู `customers`
- ูุธูุฑ ุจุฎูููุฉ ุตูุฑุงุก ุฐูุจูุฉ ูู ูุงุฆูุฉ ุงูุนููุงุก
- ุฃููููุฉ ุฎุงุตุฉ (TrendingUp) ุจุฏูุงู ูู ุงูุญุฑูู ุงูุฃููู

---

## ููุทู ุงูุนูููุฉ

### ุงููุงุนุฏุฉ ุงูุนุงูุฉ

ุนูุฏ ุฅุฌุฑุงุก ุชุญููู ุจูุจูุบ (Amount) ูุนูููุฉ (Commission):

```
ุงููุจูุบ ุงูุฃุตูู = Amount
ุงูุนูููุฉ = Commission
ุงูุตุงูู ูููุณุชููุฏ = Amount - Commission
```

### ุงูุชูุฒูุน

1. **ุงูููุฑุณู (Sender):**
   - ููุฎุตู ููู ุงููุจูุบ ุงููุงูู: `Amount`
   - ุงูุนูููุฉ ูุง ุชุคุซุฑ ุนูู ุญุณุงุจู

2. **ุงูููุณุชูุจูู (Receiver/Beneficiary):**
   - ูุณุชูู ุงูุตุงูู ููุท: `Amount - Commission`
   - ุงูุนูููุฉ ุชูุฎุตู ูู ุงููุจูุบ ูุจู ุฅุถุงูุชู ูุญุณุงุจู

3. **ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ:**
   - ูุณุชูู ุงูุนูููุฉ ูุงููุฉ: `Commission`
   - ูุชู ุชุณุฌูููุง ุชููุงุฆูุงู ูุญุฑูุฉ ูููุตูุฉ

---

## ูุซุงู ุนููู

### ุงูุณููุงุฑูู: ุฌูุงู ููุญูู ุฅูู ุนูุงุฏ

**ุงูุจูุงูุงุช:**
- ุงูููุฑุณู: ุฌูุงู
- ุงูููุณุชูุจูู: ุนูุงุฏ
- ุงููุจูุบ ุงูุฅุฌูุงูู: 5000 USD
- ุงูุนูููุฉ: 120 USD

### ูุง ูุญุฏุซ ูู ุงููุธุงู:

#### 1. ุงูุญุฑูุฉ ุงูุฃุณุงุณูุฉ (ุฌูุงู โ ุนูุงุฏ)
```
customer_id: ุนูุงุฏ
amount: 5000
commission: 120
commission_currency: USD
movement_type: incoming
```

#### 2. ุญุณุงุจ ุนูุงุฏ
- ุฑุตูุฏู ูุฒูุฏ ุจู: **4880 USD** (5000 - 120)
- ูู view `customer_balances`:
  ```sql
  incoming: 5000 - 120 = 4880
  ```

#### 3. ุญุฑูุฉ ุงูุนูููุฉ (ุชููุงุฆูุฉ)
```
customer_id: ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
amount: 120
commission: 0
currency: USD
movement_type: incoming
notes: "ุนูููุฉ ูู ุญุฑูุฉ ุฑูู MV-XXXXXX"
```

#### 4. ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
- ุฑุตูุฏู ูุฒูุฏ ุจู: **120 USD**

---

## ุนุฑุถ ุงูุจูุงูุงุช ูู ุงูุณูุฏ

### ูุง ูุธูุฑ ูููุณุชููุฏ (ุนูุงุฏ)

ุนูุฏ ุทุจุงุนุฉ ุงูุณูุฏุ ูุธูุฑ ุงูุชุงูู ุจูุถูุญ:

| ุงูุนููุงู | ุงููููุฉ |
|---------|-------|
| **ุงููุจูุบ ุงูุฅุฌูุงูู** | 5000 USD |
| **ุนููุฉ ุงูุญุณุงุจ** | ุงูุฏููุงุฑ ุงูุฃูุฑููู |
| **ุงูุนูููุฉ** | 120 USD |
| **ุงูุตุงูู** | 4880 USD |

**ุงููุจูุบ ูุชุงุจุฉู:**
```
ุฃุฑุจุนุฉ ุขูุงู ูุซูุงููุงุฆุฉ ูุซูุงููู ุฏููุงุฑุงู ุฃูุฑูููุงู
```

**ููุงุญุธุฉ ูููุฉ:** ุงููุจูุบ ูุชุงุจุฉ ููุญุณุจ ูู **ุงูุตุงูู** ูููุณ ุงููุจูุบ ุงูุฅุฌูุงูู.

---

## ุงูุชุทุจูู ุงูุชููู

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏูู ุงูุนููุงุก (customers)
```sql
CREATE TABLE customers (
  id uuid PRIMARY KEY,
  name text NOT NULL,
  phone text NOT NULL,
  is_profit_loss_account boolean DEFAULT false, -- โจ ุฌุฏูุฏ
  -- ... ุจุงูู ุงูุญููู
);

-- ุถูุงู ุญุณุงุจ ูุงุญุฏ ููุท ููุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
ALTER TABLE customers
ADD CONSTRAINT only_one_profit_loss_account
EXCLUDE USING btree (is_profit_loss_account WITH =)
WHERE (is_profit_loss_account = true);
```

#### Trigger ุชููุงุฆู
```sql
CREATE TRIGGER trigger_record_commission
  AFTER INSERT ON account_movements
  FOR EACH ROW
  EXECUTE FUNCTION record_commission_to_profit_loss();
```

**ุงููุธููุฉ:**
- ูุชู ุชุดุบููู ุชููุงุฆูุงู ุจุนุฏ ูู ุญุฑูุฉ ุฌุฏูุฏุฉ
- ุฅุฐุง ูุงูุช ุงูุนูููุฉ > 0:
  - ูููุดุฆ ุญุฑูุฉ ูููุตูุฉ ูู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
  - ุงูุญุฑูุฉ ุชููู `incoming` ุจูุจูุบ ุงูุนูููุฉ

### 2. Views ุงููุญุฏุซุฉ

#### customer_balances
```sql
-- ุญุณุงุจ ุงูุฑุตูุฏ ุงูุตุงูู (ุจุนุฏ ุฎุตู ุงูุนูููุฉ)
balance = SUM(
  CASE
    WHEN movement_type = 'incoming' THEN (amount - commission)
    WHEN movement_type = 'outgoing' THEN -(amount)
  END
)
```

**ุงูููุทู:**
- ููุญุฑูุงุช ุงููุงุฑุฏุฉ: ููุถุงู `(amount - commission)`
- ููุญุฑูุงุช ุงูุตุงุฏุฑุฉ: ููุฎุตู `amount` ูุงูู
- ุงููุชูุฌุฉ: ุงูุฑุตูุฏ ุงูุตุงูู ุงูุญูููู

### 3. ุงููุงุฌูุฉ ุงูุฃูุงููุฉ

#### ูุงุฆูุฉ ุงูุนููุงุก (customers.tsx)
```typescript
// ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ ูุธูุฑ ุจุดูู ูููุฒ
const isProfitLoss = item.is_profit_loss_account;

<TouchableOpacity
  style={[
    styles.customerCard,
    isProfitLoss && styles.profitLossCard // ุฎูููุฉ ุฐูุจูุฉ
  ]}
>
  {isProfitLoss ? (
    <TrendingUp size={28} color="#FFFFFF" /> // ุฃููููุฉ ุฎุงุตุฉ
  ) : (
    // ุงูุฃููููุฉ ุงูุนุงุฏูุฉ
  )}
  <Text>{item.name} {isProfitLoss && '๐ฐ'}</Text>
</TouchableOpacity>
```

#### ุงูุณูุฏุงุช (receiptGenerator.ts)
```typescript
// ุญุณุงุจ ุงูุตุงูู
const netAmount = Number(amount) - Number(commission || 0);

// ุงููุจูุบ ูุชุงุจุฉ ูุณุชุฎุฏู ุงูุตุงูู
const amountInWords = numberToArabicTextWithCurrency(netAmount, currency);

// ุนุฑุถ ุงูุจูุงูุงุช
<div class="info-card">
  <div class="card-label">ุงููุจูุบ ุงูุฅุฌูุงูู</div>
  <div class="card-value">${amount}</div>
</div>

<div class="info-card">
  <div class="card-label">ุงูุนูููุฉ</div>
  <div class="card-value">${commission}</div>
</div>

<div class="info-card">
  <div class="card-label">ุงูุตุงูู</div>
  <div class="card-value">${netAmount}</div>
</div>
```

---

## ุงูุดุฑูุท ูุงูููุงุนุฏ

### 1. ุงูุนูููุฉ = 0
- **ุงูุณููู:** ูุง ูุชู ุชุณุฌูู ุฃู ุญุฑูุฉ ุนูู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
- **ุงูุตุงูู:** ูุณุงูู ุงููุจูุบ ุงูุฅุฌูุงูู
- **Trigger:** ูุง ูุชู ุชุดุบููู

### 2. ุนููุฉ ุงูุนูููุฉ
- **ุงููุงุนุฏุฉ:** ุงูุนูููุฉ ุชููู ุจููุณ ุนููุฉ ุงูุญุฑูุฉ ุงูุฃุณุงุณูุฉ
- **ูุซุงู:** ุฅุฐุง ูุงู ุงูุชุญููู ุจุงูุฏููุงุฑุ ุงูุนูููุฉ ุชูุณุฌู ุจุงูุฏููุงุฑ
- **ุญูู:** `commission_currency` ูู ุฌุฏูู `account_movements`

### 3. ุชุทุจูู ุงููุธุงู
- **ุงููุทุงู:** ุฌููุน ุงูุชุญูููุงุช ุงูุชู ุชุญุชูู ุนูู ุนูููุฉ
- **ุงูุฃููุงุน:**
  - โ ุชุญูููุงุช ุจูู ุงูุนููุงุก
  - โ ุชุญูููุงุช ูู/ุฅูู ุงููุญู
  - โ ุญุฑูุงุช ูุงุฑุฏุฉ ูุตุงุฏุฑุฉ
  - โ ุงูุชุญูููุงุช ุงูุฏุงุฎููุฉ

---

## ุงูุญูุงูุฉ ูุงูุฃูุงู

### 1. ููุน ุงูุญุฐู

**ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
-- RLS Policy
CREATE POLICY "Users can delete own customers"
  ON customers FOR DELETE
  TO authenticated
  USING (is_profit_loss_account IS NOT true);

-- ูู ุฏุงูุฉ delete_customer
IF is_profit_loss THEN
  RETURN json_build_object(
    'success', false,
    'error', 'ูุง ูููู ุญุฐู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ'
  );
END IF;
```

**ูู ุงููุงุฌูุฉ:**
```typescript
const handleCustomerLongPress = (customer) => {
  if (customer.is_profit_loss_account) {
    Alert.alert(
      'ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ',
      'ูุฐุง ุญุณุงุจ ุงููุธุงู ููุง ูููู ุญุฐูู ุฃู ุชุตููุฑู.'
    );
    return;
  }
  // ... ุจุงูู ุงูุฎูุงุฑุงุช
};
```

### 2. ุถูุงู ุงููุญุฏุฉ
```sql
-- Constraint ูุถูุงู ุญุณุงุจ ูุงุญุฏ ููุท
EXCLUDE USING btree (is_profit_loss_account WITH =)
WHERE (is_profit_loss_account = true);
```

---

## ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 1. ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุงูุฃุณุงุณู

**ุงูุฎุทูุงุช:**
1. ุฅูุดุงุก ุชุญููู ูู ุนููู ุฅูู ุขุฎุฑ
2. ุฅุถุงูุฉ ูุจูุบ: 1000
3. ุฅุถุงูุฉ ุนูููุฉ: 50
4. ุญูุธ ุงูุญุฑูุฉ

**ุงูุชุญูู:**
```sql
-- 1. ุงูุชุญูู ูู ุฑุตูุฏ ุงููุณุชููุฏ
SELECT balance FROM customer_balances
WHERE customer_id = 'ุงููุณุชููุฏ' AND currency = 'USD';
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 950 (1000 - 50)

-- 2. ุงูุชุญูู ูู ุฑุตูุฏ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ
SELECT balance FROM customer_balances
WHERE is_profit_loss_account = true AND currency = 'USD';
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 50

-- 3. ุงูุชุญูู ูู ุนุฏุฏ ุงูุญุฑูุงุช
SELECT COUNT(*) FROM account_movements
WHERE notes LIKE '%ุนูููุฉ ูู ุญุฑูุฉ%';
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุนุฏุฏ ูุณุงูู ุนุฏุฏ ุงูุญุฑูุงุช ุฐุงุช ุงูุนูููุฉ
```

### 2. ุงุฎุชุจุงุฑ ุงูุนูููุฉ = 0

**ุงูุฎุทูุงุช:**
1. ุฅูุดุงุก ุชุญููู ุจุฏูู ุนูููุฉ
2. ุญูุธ ุงูุญุฑูุฉ

**ุงูุชุญูู:**
```sql
-- ุงูุชุญูู ูู ุนุฏู ุฅูุดุงุก ุญุฑูุฉ ุนูููุฉ
SELECT COUNT(*) FROM account_movements
WHERE customer_id = (SELECT id FROM customers WHERE is_profit_loss_account = true)
AND notes LIKE '%ุนูููุฉ ูู ุญุฑูุฉ MV-XXXXXX%';
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 0
```

### 3. ุงุฎุชุจุงุฑ ุงูุญูุงูุฉ ูู ุงูุญุฐู

**ุงูุฎุทูุงุช:**
1. ูุญุงููุฉ ุญุฐู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ ูู ุงููุงุฌูุฉ
2. ุงูุถุบุท ุงููุทูู ุนูู ุงูุญุณุงุจ

**ุงูุชุญูู:**
- ูุฌุจ ุฃู ูุธูุฑ Alert ูููุน ุงูุญุฐู
- ูุง ูุฌุจ ุธููุฑ ุฎูุงุฑุงุช "ุญุฐู" ุฃู "ุชุตููุฑ"

---

## ุงูููุงุฆุฏ

### 1. ูููุญุงุณุจุฉ
- โ ุชุชุจุน ุฏููู ูุฌููุน ุงูุนูููุงุช
- โ ุฑุตูุฏ ูุงุถุญ ููุฃุฑุจุงุญ
- โ ุณูููุฉ ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- โ ูุตู ุงูุฃุฑุจุงุญ ุนู ุญุณุงุจุงุช ุงูุนููุงุก

### 2. ููุดูุงููุฉ
- โ ุนุฑุถ ูุงุถุญ ูููุจูุบ ุงูุฅุฌูุงูู ูุงูุตุงูู
- โ ุงููุจูุบ ูุชุงุจุฉ ูุนูุณ ูุง ุณูุณุชููู ุงูุนููู ูุนููุงู
- โ ูุง ูุจุณ ูู ุงูุณูุฏุงุช ุงููุทุจูุนุฉ

### 3. ููุฃุชูุชุฉ
- โ ุชุณุฌูู ุชููุงุฆู ุฏูู ุชุฏุฎู ูุฏูู
- โ ุชูููู ุงูุฃุฎุทุงุก ุงูุจุดุฑูุฉ
- โ ุณุฑุนุฉ ูู ุงููุนุงููุงุช

### 4. ูููุธุงู
- โ ุจููุฉ ููุทููุฉ ูููุธูุฉ
- โ ุณูููุฉ ุงูุตูุงูุฉ ูุงูุชุทููุฑ
- โ ูุงุจููุฉ ุงูุชูุณุน ูุณุชูุจูุงู

---

## ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

### ุณ1: ูุงุฐุง ูู ุฃุฑุฏุช ุชุบููุฑ ุงุณู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑุ
**ุฌ:** ููููู ุชุนุฏูู ุงุณู ุงูุญุณุงุจ ูู ุตูุญุฉ ุชูุงุตูู ุงูุนููู. ููุท ุงุณู ุงูุญุณุงุจ ูุงุจู ููุชุนุฏููุ ุฃูุง ุงูุญุฐู ุฃู ุงูุชุตููุฑ ูููููุน.

### ุณ2: ูู ูููู ูุฌูุฏ ุฃูุซุฑ ูู ุญุณุงุจ ุฃุฑุจุงุญ ูุฎุณุงุฆุฑุ
**ุฌ:** ูุงุ ููุฌุฏ constraint ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููุน ุฅูุดุงุก ุฃูุซุฑ ูู ุญุณุงุจ ูุงุญุฏ.

### ุณ3: ูุงุฐุง ูุญุฏุซ ุฅุฐุง ุญุฐูุช ุญุฑูุฉ ุชุญุชูู ุนูู ุนูููุฉุ
**ุฌ:** ูุฌุจ ุญุฐู ุญุฑูุฉ ุงูุนูููุฉ ุงููุฑุชุจุทุฉ ูุฏููุงู ุฃู ุฅุถุงูุฉ trigger ูุญุฐููุง ุชููุงุฆูุงู (ูููุตุญ ุจุงูุญุฐู ุงููุฏูู ูุชุฌูุจ ุงูุฃุฎุทุงุก).

### ุณ4: ูู ุงูุนูููุฉ ุชุคุซุฑ ุนูู ุงูููุฑุณูุ
**ุฌ:** ูุงุ ุงูููุฑุณู ููุฎุตู ููู ุงููุจูุบ ุงููุงูู ููุท. ุงูุนูููุฉ ุชูุฎุตู ูู ุงููุณุชููุฏ.

### ุณ5: ููู ุฃุนุฑู ุฅุฌูุงูู ุงูุนูููุงุช ููุชุฑุฉ ูุนููุฉุ
**ุฌ:** ููููู ุนุฑุถ ุชูุงุตูู ุญุณุงุจ ุงูุฃุฑุจุงุญ ูุงูุฎุณุงุฆุฑ ูุฑุคูุฉ ุฌููุน ุงูุนูููุงุช ุงูููุณุฌูุฉ.

---

## ูููุงุช ุงููุดุฑูุน ุงููุนููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `supabase/migrations/*_add_profit_loss_account_v2.sql`
- `supabase/migrations/*_add_commission_auto_recording_trigger.sql`
- `supabase/migrations/*_update_views_for_net_amount_v2.sql`

### ุงูููุฏ
- `types/database.ts` - ุชุนุฑููุงุช TypeScript
- `app/(tabs)/customers.tsx` - ุนุฑุถ ูุงุฆูุฉ ุงูุนููุงุก
- `utils/receiptGenerator.ts` - ุชูููุฏ ุงูุณูุฏุงุช
- `services/receiptService.ts` - ุฎุฏูุงุช ุงูุทุจุงุนุฉ

---

## ุงูุฎูุงุตุฉ

ูุธุงู ุงูุนูููุฉ ุงูุชููุงุฆู ูููุฑ:
1. โ **ุฏูุฉ:** ุชุณุฌูู ุชููุงุฆู ูุฌููุน ุงูุนูููุงุช
2. โ **ุดูุงููุฉ:** ุนุฑุถ ูุงุถุญ ูููุจุงูุบ ูู ุงูุณูุฏุงุช
3. โ **ุญูุงูุฉ:** ููุน ุญุฐู ุญุณุงุจ ุงููุธุงู
4. โ **ุณูููุฉ:** ูุง ุญุงุฌุฉ ูุชุฏุฎู ูุฏูู

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูููุฎุชุจุฑ ุจุงููุงูู!** โจ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 31 ุฏูุณูุจุฑ 2024
