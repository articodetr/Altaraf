# ุฏููู ูุธุงู ุดุนุงุฑ ุงููุญู ุงูุดุงูู

**ุงูุชุงุฑูุฎ**: 12 ููุงูุฑ 2026
**ุงูุญุงูุฉ**: ุชู ุงูุฅุตูุงุญ ุจุงููุงูู โ

---

## ๐ ููุฎุต ุงููุดููุฉ ูุงูุญู

### ุงููุดููุฉ ุงูุฃุตููุฉ:
1. **ุงูุดุนุงุฑ ูุง ูุธูุฑ ูู ุงูุณูุฏุงุช PDF** - ูุงู ุงูููุฏุฑ ูุธูุฑ ูุงุฑุบุงู
2. **ูุดู ุญูุธ ุงูุดุนุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช** - ุนูุฏ ุฑูุน ุดุนุงุฑ ุฌุฏูุฏุ ูุง ูุชู ุญูุธู

### ุงูุณุจุจ ุงูุฌุฐุฑู:
- `logoHelper.ts` ูุงู ููุฑุฃ ููุท ูู ุงูุดุนุงุฑ ุงููุฏูุฌ (assets) ููู ููู ููุฑุฃ ุฃุจุฏุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู Supabase Storage
- `AuthContext.tsx` ูุงู ูุณุชุฎุฏู UPDATE ูููุตู ุนู INSERTุ ููุง ูุฏ ูุณุจุจ ูุดุงูู ุนูุฏ ุนุฏู ูุฌูุฏ ุณุฌู
- ุนุฏู ูุฌูุฏ error logging ูุงุถุญ

### ุงูุญู ุงููุทุจู:
โ ุฅุนุงุฏุฉ ูุชุงุจุฉ `logoHelper.ts` ุจุงููุงูู ูููุฑุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃููุงู
โ ุชุญุฏูุซ `AuthContext.tsx` ูุงุณุชุฎุฏุงู UPSERT ุจุฏูุงู ูู UPDATE/INSERT
โ ุชุญุฏูุซ `logoService.ts` ูุงุณุชุฎุฏุงู UPSERT
โ ุฅุถุงูุฉ error logging ุดุงูู ูู ุฌููุน ุงููููุงุช
โ ุฏุนู ุชุญููู ุงูุดุนุงุฑ ูู Supabase Storage ูุชุญูููู ุฅูู Base64 ููู PDF
โ fallback ุชููุงุฆู ููุดุนุงุฑ ุงูุงูุชุฑุงุถู ุนูุฏ ุญุฏูุซ ุฃู ูุดููุฉ

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏูู: `app_settings`

| ุงูุญูู | ุงูููุน | ุงููุตู | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ |
|------|------|-------|-------------------|
| `id` | uuid | ุงููุนุฑู ุงููุฑูุฏ | `gen_random_uuid()` |
| `shop_name` | text | ุงุณู ุงููุญู | `'ูุญู ุงูุญูุงูุงุช ุงููุงููุฉ'` |
| `shop_logo` | text | ุฑุงุจุท ุงูุดุนุงุฑ ุงููุฑููุน ูู Storage | `null` |
| `shop_phone` | text | ุฑูู ูุงุชู ุงููุญู | `null` |
| `shop_address` | text | ุนููุงู ุงููุญู | `null` |
| `selected_receipt_logo` | text | ุงูุดุนุงุฑ ุงููุฎุชุงุฑ ููุณูุฏุงุช | `null` |
| `updated_at` | timestamptz | ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ | `now()` |

### ุงูููู ุงูููููุฉ ูู `selected_receipt_logo`:
- `'DEFAULT'` - ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู ูู assets
- `null` ุฃู ุฑุงุจุท URL - ุงุณุชุฎุฏุงู `shop_logo` ุฃู ุงูุดุนุงุฑ ุงููุฑููุน
- ุฑุงุจุท Supabase Storage - ุงุณุชุฎุฏุงู ุดุนุงุฑ ูุญุฏุฏ

### ุงููุนุฑู ุงูุซุงุจุช:
```typescript
const FIXED_SETTINGS_ID = '00000000-0000-0000-0000-000000000000';
```

ูุณุชุฎุฏู ูุนุฑู ุซุงุจุช ูุถูุงู ูุฌูุฏ ุณุฌู ูุงุญุฏ ููุท ูู ุฌุฏูู ุงูุฅุนุฏุงุฏุงุชุ ููุง ูุฌุนู UPSERT ูุนูู ุจุดูู ููุซูู.

### RLS Policies:

ุงูุณูุงุณุฉ ุงูุญุงููุฉ ุชุณูุญ ูู `anon` ู `authenticated` ุจุงููุตูู ุงููุงูู:

```sql
CREATE POLICY "Allow anon and authenticated users full access to app_settings"
  ON app_settings
  FOR ALL
  TO anon, authenticated
  USING (true)
  WITH CHECK (true);
```

**ููุงุฐุง ูุฐุง ุขููุ**
- ุงูุชุทุจูู ูุณุชุฎุฏู ูุธุงู PIN ูุญูู ููุญูุงูุฉ
- `app_settings` ูุญุชูู ููุท ุนูู ุฅุนุฏุงุฏุงุช ุนุงูุฉ (ุงุณู ุงููุญูุ ุงูุนููุงูุ ุงูุดุนุงุฑ)
- ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุณุงุณุฉ ุชุญุชุงุฌ ุญูุงูุฉ ุฅุถุงููุฉ

---

## ๐ฆ Supabase Storage

### ุงุณู ุงูู Bucket: `shop-logos`

**ุงูุฎุตุงุฆุต:**
- **Public**: ูุนู โ (ูููู ุงููุตูู ููุตูุฑ ุจุฏูู ูุตุงุฏูุฉ)
- **ุงูุญุฏ ุงูุฃูุตู ูุญุฌู ุงูููู**: 5 MB
- **ุฃููุงุน ุงููููุงุช ุงููุณููุญุฉ**:
  - `image/jpeg`
  - `image/jpg`
  - `image/png`
  - `image/webp`

### ูููู ุงููุณุงุฑุงุช:
```
shop-logos/
โโโ logos/
    โโโ default_1234567890.jpg
    โโโ default_1234567891.png
    โโโ ...
```

### Storage Policies:

```sql
-- ูููุฑุงุกุฉ (public)
CREATE POLICY "Public Access"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'shop-logos');

-- ููุฑูุน (anon + authenticated)
CREATE POLICY "Allow upload for all users"
  ON storage.objects FOR INSERT
  TO anon, authenticated;

-- ููุชุญุฏูุซ (anon + authenticated)
CREATE POLICY "Allow update for all users"
  ON storage.objects FOR UPDATE
  TO anon, authenticated
  USING (bucket_id = 'shop-logos');

-- ููุญุฐู (anon + authenticated)
CREATE POLICY "Allow delete for all users"
  ON storage.objects FOR DELETE
  TO anon, authenticated
  USING (bucket_id = 'shop-logos');
```

---

## ๐ ููู ูุนูู ุงููุธุงูุ

### 1. ุฑูุน ุดุนุงุฑ ุฌุฏูุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ ุฃู ุงููุงููุฑุง              โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  logoService.uploadLogo(imageUri)                        โ
โ  โข ูุฑุงุกุฉ ุงูุตูุฑุฉ ูู base64                                โ
โ  โข ุงูุชุญูู ูู ุญุฌู ุงูููู (< 5 MB)                         โ
โ  โข ุฑูุน ุฅูู shop-logos/logos/[timestamp].jpg              โ
โ  โข ุงูุญุตูู ุนูู Public URL                                โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AuthContext.updateSettings({ shop_logo: url })          โ
โ  โข UPSERT ุฅูู app_settings ุจูุนุฑู ุซุงุจุช                   โ
โ  โข ุญูุธ ุงูุฑุงุจุท ูู shop_logo                              โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
         โ ุชู ุญูุธ ุงูุดุนุงุฑ ุจูุฌุงุญ
```

### 2. ุนุฑุถ ุงูุดุนุงุฑ ูู ุงูุณูุฏุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุณุชุฎุฏู ูุทูุจ ุทุจุงุนุฉ/ูุดุงุฑูุฉ ุณูุฏ                         โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  receiptService.generateAndShareReceipt()                โ
โ  โข ุงุณุชุฏุนุงุก logoHelper.getReceiptLogoBase64()            โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  logoHelper.getReceiptLogoBase64()                       โ
โ  1. ูุฑุงุกุฉ app_settings ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช               โ
โ  2. ูุญุต selected_receipt_logo                            โ
โ     โโ ุฅุฐุง 'DEFAULT' โ ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ูู assets        โ
โ     โโ ุฅุฐุง URL ูู shop-logos โ ุชุญููู ูุชุญููู ูู base64  โ
โ     โโ ุฅุฐุง null โ ุงุณุชุฎุฏุงู shop_logo ุฃู ุงูุงูุชุฑุงุถู      โ
โ  3. ุชุญููู ุงูุตูุฑุฉ ุฅูู data URL (base64)                 โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  generateReceiptHTML(data, qrCode, logoDataUrl)          โ
โ  โข ุฅุฏุฑุงุฌ ุงูุดุนุงุฑ ูู <img src="data:image/png;base64..."> โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Print.printToFileAsync() โ PDF                          โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
         โ ุงูุดุนุงุฑ ูุธูุฑ ูู ุงูุณูุฏ
```

### 3. ููุทู ุงุฎุชูุงุฑ ุงูุดุนุงุฑ

```typescript
// ูู logoHelper.getReceiptLogoBase64()

if (selected_receipt_logo === 'DEFAULT') {
  // ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู ูู assets/images/logo_1.png
  return await getBundledLogoAsDataUrl();
}

const logoUrl = selected_receipt_logo || shop_logo;

if (!logoUrl || logoUrl === 'DEFAULT') {
  // ูุง ููุฌุฏ ุดุนุงุฑ ูุฑููุน
  return await getBundledLogoAsDataUrl();
}

if (logoUrl.includes('shop-logos')) {
  // ุดุนุงุฑ ูุฑููุน ูู Supabase Storage
  const base64 = await downloadAndConvertLogoToBase64(logoUrl);
  return base64 || await getBundledLogoAsDataUrl(); // fallback
}

if (logoUrl.startsWith('http')) {
  // ุดุนุงุฑ ุฎุงุฑุฌู (GitHub, etc.)
  const base64 = await downloadAndConvertLogoToBase64(logoUrl);
  return base64 || await getBundledLogoAsDataUrl(); // fallback
}

// ุงุญุชูุงุทู ููุงุฆู
return await getBundledLogoAsDataUrl();
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `utils/logoHelper.ts` โ (ุฅุนุงุฏุฉ ูุชุงุจุฉ ูุงููุฉ)

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**

- `getReceiptLogoBase64(forceRefresh?)` - ููุฑุฃ ุงูุดุนุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุญููู ูู base64
- `getLogoUrl()` - ูุญุตู ุนูู ุฑุงุจุท ุงูุดุนุงุฑ
- `getLogoBase64(forceRefresh?)` - alias ูู getReceiptLogoBase64
- `clearLogoCache()` - ูุญุฐู ุงูุดุนุงุฑุงุช ุงููุฎุฒูุฉ ูุคูุชุงู
- `getBundledLogoAsDataUrl()` - ููุฑุฃ ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู ูู assets
- `downloadAndConvertLogoToBase64(url)` - ูุญูู ุดุนุงุฑ ูู URL ููุญููู ูู base64

**ุงูุชุญุณููุงุช:**
- โ ูุฑุงุกุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃููุงู
- โ ุฏุนู Supabase Storage URLs
- โ ุฏุนู External URLs
- โ fallback ุชููุงุฆู ููุดุนุงุฑ ุงูุงูุชุฑุงุถู
- โ error logging ุดุงูู
- โ ุฏุนู Web ู Native platforms

### 2. `contexts/AuthContext.tsx` โ

**ุงูุชุบููุฑ ุงูุฑุฆูุณู:**

```typescript
// ูุฏูู โ
if (currentSettings) {
  await supabase.from('app_settings').update(...).eq('id', ...);
} else {
  await supabase.from('app_settings').insert(...);
}

// ุฌุฏูุฏ โ
const settingsToUpsert = {
  id: FIXED_SETTINGS_ID,
  ...newSettings,
};

await supabase
  .from('app_settings')
  .upsert(settingsToUpsert, {
    onConflict: 'id',
    ignoreDuplicates: false,
  });
```

**ุงูููุงุฆุฏ:**
- โ ุนูููุฉ ูุงุญุฏุฉ ุจุฏูุงู ูู ุงุซูุชูู
- โ ูุง ุญุงุฌุฉ ููุชุญูู ูู ูุฌูุฏ ุงูุณุฌู
- โ ูุถูู ูุฌูุฏ ุณุฌู ูุงุญุฏ ููุท
- โ error logging ูุญุณูู

### 3. `services/logoService.ts` โ

**ุงูุชุญุณููุงุช:**

```typescript
// uploadLogo
const { data, error } = await supabase.storage
  .from(BUCKET_NAME)
  .upload(filePath, arrayBuffer, {
    contentType: `image/${normalizedExt}`,
    upsert: true,  // โ ูุณูุญ ุจุฅุนุงุฏุฉ ุงูุฑูุน
  });

// updateShopLogo
const settingsToUpsert = {
  id: FIXED_SETTINGS_ID,
  shop_logo: logoUrl,
};

await supabase
  .from('app_settings')
  .upsert(settingsToUpsert, {
    onConflict: 'id',
    ignoreDuplicates: false,
  });
```

**ุงููุธุงุฆู:**
- `uploadLogo(imageUri, userId?)` - ุฑูุน ุดุนุงุฑ ุฅูู Storage
- `deleteLogo(logoUrl)` - ุญุฐู ุดุนุงุฑ ูุฏูู
- `updateShopLogo(logoUrl)` - ุชุญุฏูุซ ุฑุงุจุท ุงูุดุนุงุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `updateShopSettings(settings)` - ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงููุญู
- `pickImageFromGallery()` - ุงุฎุชูุงุฑ ุตูุฑุฉ ูู ุงููุนุฑุถ
- `pickImageFromCamera()` - ุงูุชูุงุท ุตูุฑุฉ ุจุงููุงููุฑุง
- `pickPngFile()` - ุงุฎุชูุงุฑ ููู PNG

### 4. `services/receiptService.ts` โ (ุจุฏูู ุชุบููุฑ)

ูุณุชุฏุนู `getReceiptLogoBase64()` ูู logoHelperุ ูุงูุฐู ุชู ุฅุตูุงุญู.

### 5. `utils/receiptGenerator.ts` โ (ุจุฏูู ุชุบููุฑ)

ูุณุชูุจู `logoDataUrl` ูู data URL (base64) ููุถุนู ูู:

```html
${logoDataUrl
  ? `<img src="${logoDataUrl}" alt="Logo" class="company-logo" />`
  : `<div class="company-name-ar-line">ุงูุชุฑู</div>
     <div class="company-name-ar-line">ููุญูุงูุงุช ุงููุงููุฉ</div>`
}
```

---

## ๐งช ุฏููู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

### ุงูุงุฎุชุจุงุฑ 1: ุฑูุน ุดุนุงุฑ ุฌุฏูุฏ โ

**ุงูุฎุทูุงุช:**

1. ุงูุชุญ ุงูุชุทุจูู ุนูู Android ุฃู iOS
2. ุงุฐูุจ ุฅูู **ุงูุฅุนุฏุงุฏุงุช** โ **ุฅุนุฏุงุฏุงุช ุงููุญู**
3. ุงุถุบุท ุนูู **ุงุฎุชูุงุฑ ูู ุงููุนุฑุถ** ุฃู **ุงูุชูุงุท ุตูุฑุฉ**
4. ุงุฎุชุฑ ุตูุฑุฉ ุดุนุงุฑ ูุงุถุญุฉ (ููุถู ูุฑุจุนุฉุ ุฃูู ูู 5 MB)
5. ูู ูุณู "ุงูุดุนุงุฑ ูู ุงูุณูุฏุงุช"ุ ุชุฃูุฏ ูู ุงุฎุชูุงุฑ **ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงููุฑููุน**
6. ุงุถุบุท ุนูู **ุญูุธ**

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุฑุณุงูุฉ: "ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูุงูุดุนุงุฑ ุจูุฌุงุญ"
- โ ูุนุงููุฉ ุงูุดุนุงุฑ ุชุธูุฑ ูู ุงูุตูุญุฉ
- โ ูู console logs: `[logoService] Upload successful`
- โ ูู console logs: `[AuthContext] Settings upserted successfully`

**ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**

```sql
SELECT id, shop_logo, selected_receipt_logo
FROM app_settings
WHERE id = '00000000-0000-0000-0000-000000000000';
```

ูุฌุจ ุฃู ูุธูุฑ:
- `shop_logo`: ุฑุงุจุท Supabase Storage (ูุซู `https://...supabase.co/storage/v1/object/public/shop-logos/logos/default_1234567890.jpg`)
- `selected_receipt_logo`: ููุณ ุงูุฑุงุจุท ุฃู `null`

---

### ุงูุงุฎุชุจุงุฑ 2: ุงูุดุนุงุฑ ูุธูุฑ ูู ุงูุณูุฏุงุช โ

**ุงูุฎุทูุงุช:**

1. ุจุนุฏ ุฑูุน ุงูุดุนุงุฑ (ุงูุงุฎุชุจุงุฑ 1)
2. ุฃูุดุฆ ุญุฑูุฉ ุฌุฏูุฏุฉ (ุชุญููู ุฃู ุงุณุชูุงู ุฃู ุชุณููู)
3. ุงูุชุญ ุงูุณูุฏ ูู ูุงุฆูุฉ ุงูุญุฑูุงุช
4. ุงุถุบุท ุนูู **ูุดุงุฑูุฉ PDF** ุฃู **ุทุจุงุนุฉ**

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุงูุณูุฏ ูููุดุฃ ุจูุฌุงุญ
- โ ุงูุดุนุงุฑ ุงููุฑููุน ูุธูุฑ ูู ููุฏุฑ ุงูุณูุฏ (ูู ุงููุณุทุ ุจูู ุจูุงูุงุช ุงูุงุชุตุงู)
- โ ูู console logs: `[logoHelper] Found uploaded logo in Supabase Storage`
- โ ูู console logs: `[logoHelper] Successfully converted uploaded logo to base64`

**ุฅุฐุง ูู ูุธูุฑ ุงูุดุนุงุฑ:**
- โ ุงูุญุต console logs ุจุญุซุงู ุนู ุฃุฎุทุงุก
- โ ุชุฃูุฏ ูู `selected_receipt_logo` ููุณ `'DEFAULT'`
- โ ุชุญูู ูู ุตูุงุญูุงุช Storage (ูุฌุจ ุฃู ูููู public)

---

### ุงูุงุฎุชุจุงุฑ 3: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู โ

**ุงูุฎุทูุงุช:**

1. ุจุนุฏ ุฑูุน ุงูุดุนุงุฑุ ุฃุบูู ุงูุชุทุจูู ุจุงููุงูู
2. ุฃุนุฏ ูุชุญ ุงูุชุทุจูู
3. ุงุฏุฎู PIN
4. ุงุฐูุจ ุฅูู **ุฅุนุฏุงุฏุงุช ุงููุญู**

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุงูุดุนุงุฑ ุงููุฑููุน ูุธูุฑ ูู ูุนุงููุฉ ุงูุฅุนุฏุงุฏุงุช
- โ ุงูุดุนุงุฑ ูุญููุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุฎุทูุงุช 2:**

5. ุฃูุดุฆ ุณูุฏ ุฌุฏูุฏ
6. ุงูุดุนุงุฑ ูุธูุฑ ูู ุงูุณูุฏ โ

---

### ุงูุงุฎุชุจุงุฑ 4: ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู โ

**ุงูุฎุทูุงุช:**

1. ุงุฐูุจ ุฅูู **ุฅุนุฏุงุฏุงุช ุงููุญู**
2. ูู ูุณู "ุงูุดุนุงุฑ ูู ุงูุณูุฏุงุช"ุ ุงุฎุชุฑ **ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู**
3. ุงุถุบุท **ุญูุธ**
4. ุฃูุดุฆ ุณูุฏ ุฌุฏูุฏ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ `selected_receipt_logo` ูุชู ุชุญุฏูุซู ุฅูู `'DEFAULT'`
- โ ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู (`assets/images/logo_1.png`) ูุธูุฑ ูู ุงูุณูุฏุงุช
- โ ูู console logs: `[logoHelper] User selected DEFAULT logo, using bundled logo`

---

### ุงูุงุฎุชุจุงุฑ 5: ุจูุงุก APK ููู Android โ

**ุงูุฎุทูุงุช:**

1. ุงุจูู ุงูุชุทุจูู ูู APK ุจุงุณุชุฎุฏุงู EAS Build
2. ุซุจูุช ุงูู APK ุนูู ุฌูุงุฒ Android ุญูููู
3. ุงูุชุญ ุงูุชุทุจูู ูุงุฑูุน ุดุนุงุฑ ุฌุฏูุฏ
4. ุฃูุดุฆ ุณูุฏ ูุชุญูู ูู ุธููุฑ ุงูุดุนุงุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุงูุดุนุงุฑ ูุธูุฑ ูู ุงูุณูุฏุงุช ูู ูุณุฎุฉ APK (ูููุณ ููุท ูู ุงูุชุทููุฑ)
- โ ุชุญููู ุงูุดุนุงุฑ ูู Supabase Storage ูุนูู ุจุดูู ุตุญูุญ
- โ ุงูุชุญููู ุฅูู base64 ูุนูู ุจุดูู ููุซูู

**ููุงุญุธุงุช ูููุฉ:**
- ุนูู Androidุ ูุชู ุชุญููู ุงูุดุนุงุฑ ูู Storage ุจุงุณุชุฎุฏุงู `FileSystem.downloadAsync()`
- ุซู ูุชู ุชุญูููู ุฅูู base64 ุจุงุณุชุฎุฏุงู `FileSystem.readAsStringAsync()`
- ูุฐุง ูุทููุจ ูุฃู PDF ูุง ูุฏุนู ุชุญููู ุงูุตูุฑ ุงูุจุนูุฏุฉ ูุจุงุดุฑุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: "ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"

**ุงูุญููู:**

1. **ุชุญูู ูู RLS Policies:**
```sql
SELECT policyname, cmd, roles
FROM pg_policies
WHERE tablename = 'app_settings';
```

ูุฌุจ ุฃู ุชุณูุญ ุงูุณูุงุณุงุช ูู `anon` ุจุงูุนูููุงุช:
```sql
CREATE POLICY "Allow anon and authenticated users full access to app_settings"
  ON app_settings FOR ALL
  TO anon, authenticated
  USING (true) WITH CHECK (true);
```

2. **ุชุญูู ูู ูุฌูุฏ ุงูุณุฌู:**
```sql
SELECT * FROM app_settings
WHERE id = '00000000-0000-0000-0000-000000000000';
```

ุฅุฐุง ูู ููุฌุฏุ ุฃูุดุฆู:
```sql
INSERT INTO app_settings (id, shop_name)
VALUES ('00000000-0000-0000-0000-000000000000', 'ุงูุชุฑู ููุญูุงูุงุช ุงููุงููุฉ');
```

3. **ุงูุญุต console logs:**
ุงุจุญุซ ุนู:
- `[AuthContext] Upsert error:`
- `[AuthContext] Error code:`
- `[AuthContext] Error message:`

---

### ุงููุดููุฉ: ุงูุดุนุงุฑ ูุง ูุธูุฑ ูู ุงูุณูุฏุงุช

**ุงูุญููู:**

1. **ุงูุญุต console logs ุนูุฏ ุฅูุดุงุก ุงูุณูุฏ:**
```
[logoHelper] getReceiptLogoBase64 called
[logoHelper] Settings loaded: { selected_receipt_logo: ..., shop_logo: ... }
```

2. **ุชุญูู ูู ูููุฉ `selected_receipt_logo`:**
```sql
SELECT selected_receipt_logo FROM app_settings;
```

- ุฅุฐุง ูุงูุช `'DEFAULT'` โ ุณูุณุชุฎุฏู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู
- ุฅุฐุง ูุงูุช ุฑุงุจุท URL โ ุณูุญุงูู ุชุญูููู
- ุฅุฐุง ูุงูุช `null` โ ุณูุณุชุฎุฏู `shop_logo`

3. **ุชุญูู ูู Storage policies:**
```sql
SELECT policyname, cmd, roles, qual
FROM pg_policies
WHERE schemaname = 'storage' AND tablename = 'objects';
```

ูุฌุจ ุฃู ุชููู ููุงู ุณูุงุณุฉ SELECT ููู public:
```sql
CREATE POLICY "Public Access"
  ON storage.objects FOR SELECT
  TO public
  USING (bucket_id = 'shop-logos');
```

4. **ุงุฎุชุจุงุฑ ุชุญููู ุงูุดุนุงุฑ ูุฏููุงู:**
ุงูุชุญ ุฑุงุจุท ุงูุดุนุงุฑ ูู ุงููุชุตูุญ:
```
https://[YOUR_PROJECT].supabase.co/storage/v1/object/public/shop-logos/logos/default_1234567890.jpg
```

ุฅุฐุง ูู ููุชุญ โ ูุดููุฉ ูู Storage policies

---

### ุงููุดููุฉ: "ุญุฌู ุงูููู ูุจูุฑ ุฌุฏุงู"

**ุงูุญู:**
ุงูุญุฏ ุงูุฃูุตู ูู 5 MB. ุงุณุชุฎุฏู ุฃุฏุงุฉ ุถุบุท ุงูุตูุฑ:
- [TinyPNG](https://tinypng.com/) ููู PNG
- [JPEG Optimizer](https://www.jpeg-optimizer.com/) ููู JPG
- ุฃู ููู ุฌูุฏุฉ ุงูุตูุฑุฉ ุนูุฏ ุงูุงุฎุชูุงุฑ (quality: 0.7 ูู expo-image-picker)

---

### ุงููุดููุฉ: ุงูุดุนุงุฑ ูุธูุฑ ูู ุงูุชุทููุฑ ูููู ููุณ ูู APK

**ุงูุญู:**

1. ุชุฃูุฏ ูู ุฃู ุงูุดุนุงุฑ ููุญููู ูู Supabase Storage (ูููุณ ูู assets)
2. ุงูุญุต console logs ูู Android Studio Logcat
3. ุชุญูู ูู ุฃู `FileSystem.downloadAsync()` ูุนูู:

```typescript
// ูู logoHelper.ts
console.log('[logoHelper] Download result status:', downloadResult.status);
console.log('[logoHelper] Downloaded to:', downloadResult.uri);
```

4. ุชุฃูุฏ ูู ุตูุงุญูุงุช ุงูุฅูุชุฑูุช ูู `AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.INTERNET" />
```

---

## ๐ ูุฎุทุท ุชุฏูู ุงูุจูุงูุงุช ุงููุงูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ุงููุณุชุฎุฏู                               โ
โ            (ูุฎุชุงุฑ ุดุนุงุฑ ูู ุงููุนุฑุถ/ุงููุงููุฑุง)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  shop-settings.tsx                          โ
โ  โข pickImageFromGallery() ุฃู pickImageFromCamera()          โ
โ  โข ุนุฑุถ ูุนุงููุฉ ุงูุตูุฑุฉ ุงููุฎุชุงุฑุฉ                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ ุนูุฏ ุงูุถุบุท ุนูู "ุญูุธ"
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               logoService.uploadLogo(uri)                   โ
โ  1. ูุฑุงุกุฉ ุงูุตูุฑุฉ ูู base64                                 โ
โ  2. ุงูุชุญูู ูู ุญุฌู ุงูููู (< 5 MB)                           โ
โ  3. ุฑูุน ุฅูู Supabase Storage                               โ
โ     bucket: shop-logos                                      โ
โ     path: logos/default_1234567890.jpg                      โ
โ  4. ุงูุญุตูู ุนูู Public URL                                  โ
โ     https://...supabase.co/.../shop-logos/logos/...         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          AuthContext.updateSettings({ shop_logo: url })     โ
โ  UPSERT ุฅูู app_settings:                                  โ
โ  {                                                          โ
โ    id: '00000000-0000-0000-0000-000000000000',             โ
โ    shop_logo: 'https://...supabase.co/.../logo.jpg',       โ
โ    selected_receipt_logo: url ุฃู 'DEFAULT'                 โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
               โโโโโโโโโโโโโโโโโโโโโโ
               โ  Supabase Database โ
               โ    app_settings    โ
               โ   (ุชู ุงูุญูุธ โ)    โ
               โโโโโโโโโโโโโโโโโโโโโโ
```

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               ุงููุณุชุฎุฏู (ูุทูุจ ุทุจุงุนุฉ ุณูุฏ)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         receiptService.generateAndShareReceipt()            โ
โ  โข ุชุฌููุน ุจูุงูุงุช ุงูุณูุฏ (ุฑููุ ูุจูุบุ ุนูููุ ...)               โ
โ  โข ุงุณุชุฏุนุงุก logoHelper.getReceiptLogoBase64()               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           logoHelper.getReceiptLogoBase64()                 โ
โ  1. ูุฑุงุกุฉ app_settings ูู Supabase                         โ
โ     SELECT selected_receipt_logo, shop_logo                 โ
โ  2. ูุญุต selected_receipt_logo:                              โ
โ     โโ 'DEFAULT' โ getBundledLogoAsDataUrl()               โ
โ     โโ URL ูู shop-logos โ                                 โ
โ     โ    downloadAndConvertLogoToBase64(url)               โ
โ     โโ null โ ุงุณุชุฎุฏุงู shop_logo                            โ
โ  3. ุชุญููู ุฅูู data URL:                                    โ
โ     data:image/png;base64,iVBORw0KGgo...                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   downloadAndConvertLogoToBase64(logoUrl)  (ุฅุฐุง ูุฑููุน)     โ
โ  1. FileSystem.downloadAsync(logoUrl, tempPath)             โ
โ  2. FileSystem.readAsStringAsync(tempPath, base64)          โ
โ  3. return `data:image/jpeg;base64,${base64}`               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     generateReceiptHTML(data, qrCode, logoDataUrl)          โ
โ  <img src="${logoDataUrl}" class="company-logo" />          โ
โ  (ุงูุดุนุงุฑ ูุฏูุฌ ูู HTML ูู data URL)                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Print.printToFileAsync(html)                   โ
โ  โข ุชุญููู HTML ุฅูู PDF                                      โ
โ  โข ุงูุดุนุงุฑ ููุฑุณู ุฏุงุฎู PDF (embedded base64)                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
               โโโโโโโโโโโโโโโโโโโโโโ
               โ   PDF File โ      โ
               โ (ุงูุดุนุงุฑ ุธุงูุฑ)     โ
               โโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ ููุฎุต ููุงุฆู

### ูุง ุชู ุฅุตูุงุญู:

1. โ **logoHelper.ts** - ููุฑุฃ ุงูุขู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุญูู ุงูุดุนุงุฑ ูู Storage
2. โ **AuthContext.tsx** - ูุณุชุฎุฏู UPSERT ุจูุนุฑู ุซุงุจุช
3. โ **logoService.ts** - ูุณุชุฎุฏู UPSERT ููุฏูู error logging ุดุงูู
4. โ **ุฏุนู Supabase Storage** - ุฑูุนุ ุชุญูููุ ุญุฐู ุงูุดุนุงุฑุงุช
5. โ **ุชุญููู ุฅูู Base64** - ุงูุดุนุงุฑ ูุนูู ูู PDF ุนูู Android
6. โ **fallback ุชููุงุฆู** - ุฅุฐุง ูุดู ุฃู ุดูุกุ ูุนูุฏ ููุดุนุงุฑ ุงูุงูุชุฑุงุถู

### ููููุฉ ุงูุงุณุชุฎุฏุงู:

1. **ุฑูุน ุดุนุงุฑ ุฌุฏูุฏ:**
   - ุงูุฅุนุฏุงุฏุงุช โ ุฅุนุฏุงุฏุงุช ุงููุญู โ ุงุฎุชูุงุฑ ูู ุงููุนุฑุถ โ ุญูุธ

2. **ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู:**
   - ุงูุฅุนุฏุงุฏุงุช โ ุฅุนุฏุงุฏุงุช ุงููุญู โ ุงุณุชุฎุฏุงู ุงูุดุนุงุฑ ุงูุงูุชุฑุงุถู โ ุญูุธ

3. **ุนุฑุถ ุงูุดุนุงุฑ ูู ุงูุณูุฏุงุช:**
   - ููุดุฃ ุชููุงุฆูุงู ุนูุฏ ุฅูุดุงุก/ุทุจุงุนุฉ ุฃู ุณูุฏ

### ูุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช:

- **ุงูุฌุฏูู:** `app_settings`
- **ุงูุนููุฏ:** `shop_logo` (ุฑุงุจุท ุงูุดุนุงุฑ ุงููุฑููุน)
- **ุงูุนููุฏ:** `selected_receipt_logo` ('DEFAULT' ุฃู ุฑุงุจุท ุฃู null)
- **ุงููุนุฑู ุงูุซุงุจุช:** `00000000-0000-0000-0000-000000000000`

### ูุนูููุงุช Storage:

- **Bucket:** `shop-logos`
- **ุงููุณุงุฑ:** `logos/[userId]_[timestamp].[ext]`
- **Public:** ูุนู โ
- **ุงูุญุฏ ุงูุฃูุตู:** 5 MB
- **ุงูุฃููุงุน:** JPG, PNG, WEBP

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:

1. ุงูุญุต console logs ุจุญุซุงู ุนู ุฃุฎุทุงุก
2. ุชุญูู ูู RLS policies ูู Supabase
3. ุชุฃูุฏ ูู ูุฌูุฏ ุงูุณุฌู ูู app_settings
4. ุชุญูู ูู Storage bucket policies
5. ุฑุงุฌุน ูุฐุง ุงูุฏููู ููุญููู

---

**ุชู ุงูุชูุซูู ุจูุงุณุทุฉ:** Claude Sonnet 4.5
**ุงูุชุงุฑูุฎ:** 12 ููุงูุฑ 2026
**ุงูุฅุตุฏุงุฑ:** 1.0.0
